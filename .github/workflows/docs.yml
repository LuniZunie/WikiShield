name: Generate and Deploy Documentation

on:
  push:
    branches:
      - main
    paths:
      - "src/**/*.js"
      - "src/**/*.jsx"
      - "jsdoc.json"
      - "scripts/generate-docs.js"

jobs:
  generate-docs:
    runs-on: ubuntu-latest

    permissions:
      contents: write

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Generate documentation
        run: npm run docs

      - name: Configure Git
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

      - name: Deploy to docs branch
        run: |
          # Save generated docs to a temporary location
          mkdir -p /tmp/docs-output
          cp -r docs/* /tmp/docs-output/

          # Create .nojekyll file to allow files starting with underscore
          touch /tmp/docs-output/.nojekyll

          # Switch to docs branch (create if it doesn't exist)
          git fetch origin docs 2>/dev/null || true
          git checkout docs 2>/dev/null || git checkout --orphan docs

          # Clean the branch
          git rm -rf . 2>/dev/null || true
          rm -rf *

          # Copy generated docs to root
          cp -r /tmp/docs-output/* .

          # Add all files
          git add -A

          # Commit changes if there are any
          if ! git diff --cached --quiet 2>/dev/null; then
            git commit -m " Update documentation from ${{ github.sha }}"
            git push origin docs --force
            echo " Documentation deployed successfully to docs branch"
          else
            echo "â„¹ No changes to documentation"
          fi
